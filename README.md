# ABAP Code Generation Assistant (n8n + runtime Word templates)

This MVP is a Vite + React web app that mirrors the ABAP-Jan2026 concept while swapping ChatKit for an **n8n workflow**. It keeps the repository binary-free: Word templates are generated on the fly in the browser and parsed back with Mammoth.

## Features
- **n8n webhook integration:** Uses `VITE_N8N_WEBHOOK_URL` to post RICEF payloads; n8n calls the OpenAI API internally and returns structured ABAP output.
- **Runtime Word templates:** Generate `.docx` templates at runtime from text-only definitions in `/public/templates-source/`. Upload `.docx` (generated by this app) or `.md` to pre-fill the form.
- **RICEF-aware form:** Switch between Report, Interface, Conversion, Enhancement, and Form schemas; send variables plus additional requirements to n8n.
- **Output tools:** Copy ABAP, download `.abap`, refine with prior output, and export a Word deliverable generated in-browser (no committed binaries).

## Getting started
1. Install dependencies (offline registries may require configuration):
   ```bash
   npm install
   ```
2. Create a `.env` file with your n8n webhook URL:
   ```bash
   VITE_N8N_WEBHOOK_URL=https://your-n8n-host/webhook/abap-agent
   ```
3. Run the app:
   ```bash
   npm run dev
   ```
4. Open `http://localhost:5173` and select a RICEF type to start.

If your environment blocks the public npm registry, mirror the packages listed in `package.json` to an allowed registry and re-run `npm install`.

## n8n workflow (beginner friendly)
Create a minimal flow that accepts the app payload and calls OpenAI:

1. **Webhook** node (production URL recommended)
   - Method: `POST`
   - Path: `abap-agent`
   - Response mode: `On Received`
   - Response content type: `JSON`
2. **Function** node (normalize and validate)
   ```javascript
   const body = items[0].json;
   if (!body.ricefType) {
     throw new Error('ricefType is required');
   }
   if (!body.templateVariables) {
     throw new Error('templateVariables are required');
   }

   const systemMessage = `You are an ABAP assistant. Generate ${body.ricefType} deliverables. Use concise, transport-safe code.`;
   const userMessage = [
     `Template text: ${body.templateText || 'n/a'}`,
     `Variables: ${JSON.stringify(body.templateVariables)}`,
     `Additional requirements: ${body.additionalRequirements || 'n/a'}`,
     body.previousAbapCode ? `Previous ABAP: ${body.previousAbapCode}` : '',
     body.refinementInstructions ? `Refinement: ${body.refinementInstructions}` : '',
   ]
     .filter(Boolean)
     .join('\n');

   return [
     {
       json: {
         messages: [
           { role: 'system', content: systemMessage },
           { role: 'user', content: userMessage },
         ],
         model: body.model || 'gpt-4o-mini',
         temperature: body.temperature ?? 0.2,
         max_tokens: body.maxTokens ?? 1200,
       },
     },
   ];
   ```
3. **HTTP Request** node (OpenAI Chat Completions)
   - URL: `https://api.openai.com/v1/chat/completions`
   - Method: `POST`
   - Authentication: Bearer header with your OpenAI key
   - Body: `{{$json}}`
4. **Set** node (shape response)
   - Keep Only Set: `true`
   - JSON values to set:
     ```json
     {
       "abapCode": "{{$json[\"choices\"][0][\"message\"][\"content\"]}}",
       "notes": "Generated via n8n OpenAI call",
       "questions": []
     }
     ```
5. Activate the workflow and use the production webhook URL in `VITE_N8N_WEBHOOK_URL`.

### Example request/response
Request body sent by the app:
```json
{
  "ricefType": "Report",
  "templateVariables": {"projectName": "Bluefield", "reportTitle": "POs by Vendor"},
  "templateText": "Project Name: Bluefield...",
  "additionalRequirements": "Avoid SELECT *; add auth checks",
  "previousAbapCode": "OPTIONAL",
  "refinementInstructions": "OPTIONAL"
}
```

Example response the app expects:
```json
{
  "abapCode": "REPORT z_example. WRITE: 'Hello ABAP'.",
  "notes": "Transport-safe coding applied.",
  "questions": ["Do you need ALV grid or list?"]
}
```

## Template sources (text-only)
Markdown template outlines live in `/public/templates-source/`. They power runtime `.docx` generation and are safe to keep in Git. At runtime you can:
- **Download Word Template:** Generates `.docx` in the browser from the schema (no binary committed).
- **Download Markdown Template:** Direct link to the text outline.
- **Upload Template:** Accepts `.docx` generated by the app (text is extracted with Mammoth) or `.md` outlines; parsed fields pre-fill the form.

## Output downloads
- **Copy / .abap download:** Save the ABAP code directly.
- **Download Word output:** Builds a `.docx` summary with inputs, notes, questions, and code. Generated client-side with the `docx` package.

## Binary safety
The repository keeps `.docx` (and other binaries) out of version control. `.gitignore` enforces this; all documents are generated on demand in the browser.
